#!/usr/bin/env bash

# OrcMate - Keyboard-First AI Terminal Environment Manager
# A wrapper around Tmux and Git Worktree for isolated AI-assisted development

set -euo pipefail

VERSION="0.1.0"
WORKTREE_DIR=".worktrees"
BRANCH_PREFIX="agent"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
error() {
    echo -e "${RED}ERROR:${NC} $1" >&2
    exit 1
}

success() {
    echo -e "${GREEN}✓${NC} $1"
}

info() {
    echo -e "${BLUE}→${NC} $1"
}

warn() {
    echo -e "${YELLOW}!${NC} $1"
}

# Check if running in a git repository
check_git_repo() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        error "Not in a git repository. Please run this command from within a git repository."
    fi
}

# Check dependencies
check_dependencies() {
    local missing_deps=()
    
    if ! command -v tmux &> /dev/null; then
        missing_deps+=("tmux")
    fi
    
    if ! command -v git &> /dev/null; then
        missing_deps+=("git")
    fi
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        error "Missing dependencies: ${missing_deps[*]}. Please install them first."
    fi
}

# Get the repository root directory
get_repo_root() {
    git rev-parse --show-toplevel
}

# Start a new OrcMate session
orc_start() {
    local task_name="${1:-}"
    
    if [ -z "$task_name" ]; then
        error "Task name is required. Usage: orc start <task-name>"
    fi
    
    check_git_repo
    check_dependencies
    
    local repo_root
    repo_root=$(get_repo_root)
    local worktree_path="${repo_root}/${WORKTREE_DIR}/${task_name}"
    local branch_name="${BRANCH_PREFIX}/${task_name}"
    
    # Check if worktree already exists
    if [ -d "$worktree_path" ]; then
        error "Worktree '${task_name}' already exists at ${worktree_path}"
    fi
    
    # Check if tmux session already exists
    if tmux has-session -t "$task_name" 2>/dev/null; then
        error "Tmux session '${task_name}' already exists. Use 'tmux attach -t ${task_name}' or clean it first."
    fi
    
    info "Creating OrcMate environment for task: ${task_name}"
    
    # Create worktree directory if it doesn't exist
    mkdir -p "${repo_root}/${WORKTREE_DIR}"
    
    # Create git worktree and new branch
    info "Creating git worktree at ${worktree_path}"
    if ! git worktree add -b "$branch_name" "$worktree_path" 2>/dev/null; then
        # If branch already exists, checkout without creating
        if git show-ref --verify --quiet "refs/heads/${branch_name}"; then
            warn "Branch ${branch_name} already exists, checking it out"
            git worktree add "$worktree_path" "$branch_name"
        else
            error "Failed to create worktree"
        fi
    fi
    success "Git worktree created on branch: ${branch_name}"
    
    # Copy .env file if it exists
    if [ -f "${repo_root}/.env" ]; then
        info "Copying .env file to worktree"
        cp "${repo_root}/.env" "${worktree_path}/.env"
        success ".env file copied"
    fi
    
    # Create tmux session with split layout
    info "Creating tmux session: ${task_name}"
    
    # Create new tmux session, start in the worktree directory
    tmux new-session -d -s "$task_name" -c "$worktree_path"
    
    # Split window horizontally (top 70%, bottom 30%)
    tmux split-window -v -p 30 -t "${task_name}:0" -c "$worktree_path"
    
    # Select the top pane (pane 0)
    tmux select-pane -t "${task_name}:0.0"
    
    # Send command to start claude in the top pane (if claude is available)
    if command -v claude &> /dev/null; then
        tmux send-keys -t "${task_name}:0.0" "claude" C-m
    else
        # Just start a shell and show a message
        tmux send-keys -t "${task_name}:0.0" "echo 'OrcMate Action Pane - Start your AI assistant here (e.g., claude)'" C-m
    fi
    
    # Send command to start zsh in the bottom pane (monitor pane)
    if command -v zsh &> /dev/null; then
        tmux send-keys -t "${task_name}:0.1" "zsh" C-m
    else
        tmux send-keys -t "${task_name}:0.1" "bash" C-m
    fi
    tmux send-keys -t "${task_name}:0.1" "echo 'OrcMate Monitor Pane - Run tests, logs, and commands here'" C-m
    
    success "Tmux session created with 2 panes"
    success "Environment ready! Attaching to session..."
    
    echo ""
    info "Workspace: ${worktree_path}"
    info "Branch: ${branch_name}"
    echo ""
    
    # Attach to the session
    tmux attach-session -t "$task_name"
}

# Clean up an OrcMate session
orc_clean() {
    local task_name="${1:-}"
    
    if [ -z "$task_name" ]; then
        error "Task name is required. Usage: orc clean <task-name>"
    fi
    
    check_git_repo
    
    local repo_root
    repo_root=$(get_repo_root)
    local worktree_path="${repo_root}/${WORKTREE_DIR}/${task_name}"
    local branch_name="${BRANCH_PREFIX}/${task_name}"
    
    info "Cleaning up OrcMate environment: ${task_name}"
    
    # Kill tmux session if it exists
    if tmux has-session -t "$task_name" 2>/dev/null; then
        info "Killing tmux session: ${task_name}"
        tmux kill-session -t "$task_name"
        success "Tmux session killed"
    else
        warn "Tmux session '${task_name}' not found"
    fi
    
    # Remove git worktree
    if [ -d "$worktree_path" ]; then
        info "Removing git worktree: ${worktree_path}"
        git worktree remove "$worktree_path" --force
        success "Git worktree removed"
    else
        warn "Worktree '${task_name}' not found at ${worktree_path}"
    fi
    
    # Delete git branch
    if git show-ref --verify --quiet "refs/heads/${branch_name}"; then
        info "Deleting branch: ${branch_name}"
        git branch -D "$branch_name"
        success "Branch deleted"
    else
        warn "Branch '${branch_name}' not found"
    fi
    
    success "Environment cleaned up successfully!"
}

# List active OrcMate sessions
orc_list() {
    check_git_repo
    
    local repo_root
    repo_root=$(get_repo_root)
    
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════${NC}"
    echo -e "${BLUE}   OrcMate Active Environments${NC}"
    echo -e "${BLUE}═══════════════════════════════════════${NC}"
    echo ""
    
    # List git worktrees
    echo -e "${GREEN}Git Worktrees:${NC}"
    if [ -d "${repo_root}/${WORKTREE_DIR}" ] && [ -n "$(ls -A "${repo_root}/${WORKTREE_DIR}" 2>/dev/null)" ]; then
        git worktree list | grep "${WORKTREE_DIR}" || echo "  (none)"
    else
        echo "  (none)"
    fi
    
    echo ""
    
    # List tmux sessions
    echo -e "${GREEN}Tmux Sessions:${NC}"
    if tmux list-sessions 2>/dev/null; then
        true
    else
        echo "  (none)"
    fi
    
    echo ""
    echo -e "${BLUE}═══════════════════════════════════════${NC}"
    echo ""
}

# Show help
show_help() {
    cat << EOF
OrcMate v${VERSION} - Keyboard-First AI Terminal Environment Manager

USAGE:
    orc <command> [arguments]

COMMANDS:
    start <task-name>   Create a new isolated environment (worktree + tmux)
    clean <task-name>   Remove an environment and all its resources
    list                List all active environments
    help                Show this help message
    version             Show version information

EXAMPLES:
    orc start fix-login-bug     # Start working on a bug fix
    orc list                    # See all active environments
    orc clean fix-login-bug     # Clean up when done

WORKFLOW:
    1. Start: Create isolated environment
       $ orc start my-feature
    
    2. Work: Code with AI in Pane 1, Test in Pane 2
       [Pane 1: AI Assistant] [Pane 2: Tests/Logs]
    
    3. Clean: Merge your changes, then clean up
       $ git merge agent/my-feature
       $ orc clean my-feature

For more information, see the docs/ directory.
EOF
}

# Show version
show_version() {
    echo "OrcMate v${VERSION}"
}

# Main command router
main() {
    local command="${1:-}"
    
    case "$command" in
        start)
            shift
            orc_start "$@"
            ;;
        clean)
            shift
            orc_clean "$@"
            ;;
        list|ls)
            orc_list
            ;;
        help|--help|-h)
            show_help
            ;;
        version|--version|-v)
            show_version
            ;;
        "")
            show_help
            exit 1
            ;;
        *)
            error "Unknown command: $command. Run 'orc help' for usage."
            ;;
    esac
}

main "$@"
